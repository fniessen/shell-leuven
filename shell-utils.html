<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shell utilities</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Fabrice Niessen" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
</head>
<body>
<div id="content">
<h1 class="title">Shell utilities</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#orgff6d7c2">1. Context</a>
<ul>
<li><a href="#orgdb07cf4">1.1. Description</a></li>
<li><a href="#org8b71b7f">1.2. See also</a></li>
<li><a href="#org48f7ba3">1.3. Coding style</a></li>
<li><a href="#org91bfd34">1.4. Prerequisites</a></li>
</ul>
</li>
<li><a href="#org6c04ac8">2. Shell aliases</a>
<ul>
<li><a href="#org81d677a">2.1. Find all of the distinct file extensions in a folder hierarchy</a></li>
</ul>
</li>
<li><a href="#org54ed5a4">3. Shell functions</a>
<ul>
<li><a href="#orgd57b9ad">3.1. Exit with an error</a></li>
<li><a href="#org00fdba9">3.2. Check for executable files</a></li>
<li><a href="#org555eb3a">3.3. Check for Cygwin executable files</a></li>
<li><a href="#org57f123d">3.4. Find the name of the parent process</a></li>
<li><a href="#orgf9f342f">3.5. Find recent files</a></li>
</ul>
</li>
<li><a href="#org08898f1">4. Shell scripts</a>
<ul>
<li><a href="#orgc46ed8b">4.1. Send an email</a>
<ul>
<li><a href="#org478beaa">4.1.1. Name</a></li>
<li><a href="#org7302838">4.1.2. Synopsis</a></li>
<li><a href="#org11f7f92">4.1.3. Description</a></li>
<li><a href="#orgfbfa55b">4.1.4. Options</a></li>
<li><a href="#orgb55e5c1">4.1.5. Stdin</a></li>
<li><a href="#orga18abb8">4.1.6. Input files</a></li>
<li><a href="#orgdae32c6">4.1.7. Environment variables</a></li>
<li><a href="#org24e0f85">4.1.8. Stdout</a></li>
<li><a href="#org8c52c90">4.1.9. Stderr</a></li>
<li><a href="#orge015f88">4.1.10. Output files</a></li>
<li><a href="#org6e4b41a">4.1.11. Exit status</a></li>
<li><a href="#org5852ab5">4.1.12. Examples</a></li>
<li><a href="#org8797df8">4.1.13. Code</a></li>
</ul>
</li>
<li><a href="#org5d01694">4.2. Echo text in color</a></li>
<li><a href="#org21baa08">4.3. Find duplicates</a>
<ul>
<li><a href="#org4c97ed4">4.3.1. finddup &#x2013; find DUPlicate files</a></li>
<li><a href="#org756c2af">4.3.2. findsn &#x2013; find Same Name (problems with clashing names)</a></li>
<li><a href="#org37d9fe4">4.3.3. grep2 &#x2013; Find all AXVW files with two strings (Show AXVW files with both matches only)</a></li>
</ul>
</li>
<li><a href="#orgb60960a">4.4. Utils</a></li>
</ul>
</li>
<li><a href="#org38c5c9a">5. Findup</a></li>
<li><a href="#orgb346e2d">6. Compare two files and print unmatched lines / Deleting lines from one file which are in another file</a>
<ul>
<li><a href="#org06b15bf">6.1. Comm</a></li>
<li><a href="#org1486111">6.2. AWK</a></li>
<li><a href="#org751e7c8">6.3. Diff</a></li>
</ul>
</li>
<li><a href="#org1c3a97c">7. Recursively run chmod -x?</a>
<ul>
<li><a href="#org550e37a">7.1. Convert the files with 755 permissions to 644</a></li>
<li><a href="#orgfca50d3">7.2. Pictures, etc.</a></li>
</ul>
</li>
<li><a href="#org55a75ba">8. VC</a>
<ul>
<li><a href="#orgd2812ff">8.1. Ignore files from the command line</a></li>
</ul>
</li>
<li><a href="#org63419b9">9. Web security assessments</a>
<ul>
<li><a href="#org4b8ee2d">9.1. HTTP</a></li>
<li><a href="#org5e8a7a8">9.2. HTTPS</a></li>
</ul>
</li>
<li><a href="#org3ce6e0d">10. Netcat</a>
<ul>
<li><a href="#org0938781">10.1. Scan only certain ports</a></li>
<li><a href="#orga8382c7">10.2. DNS</a></li>
<li><a href="#org19e9c12">10.3. Spoof source IP address</a></li>
<li><a href="#org8987ccd">10.4. Socat</a></li>
<li><a href="#orga157ae7">10.5. Packet forger</a></li>
<li><a href="#org729fc99">10.6. Lauching attacks via Tor</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="org-src-container">
<pre class="src src-emacs-lisp" id="org316fb3c">(format-time-string <span class="org-string">"%Y%m%d.%H%M"</span>)
</pre>
</div>

<div id="outline-container-orgff6d7c2" class="outline-2">
<h2 id="orgff6d7c2"><span class="section-number-2">1</span> Context</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgdb07cf4" class="outline-3">
<h3 id="orgdb07cf4"><span class="section-number-3">1.1</span> Description</h3>
<div class="outline-text-3" id="text-1-1">
<p>
The shell utilities are core shell functions and scripts which I wrote when
doing my day-to-day tasks.  Over time, this will become a <b>powerful toolkit</b>.
</p>

<div class="note">
<p>
Library of Babel needs the <code>#+name</code> field to &ldquo;ingest&rdquo; a code block.
</p>

</div>
</div>
</div>

<div id="outline-container-org8b71b7f" class="outline-3">
<h3 id="org8b71b7f"><span class="section-number-3">1.2</span> See also</h3>
<div class="outline-text-3" id="text-1-2">
<p>
For similar collections, see:
</p>

<ul class="org-ul">
<li><a href="http://icodesnippet.com/">http://icodesnippet.com/</a></li>
<li><a href="http://exploitsdownload.com/">http://exploitsdownload.com/</a></li>
<li><a href="http://code.google.com/">http://code.google.com/</a></li>
<li><a href="https://bbs.archlinux.org/viewtopic.php?id=56646&amp;p=1">Post your handy self made command line utilities</a></li>
</ul>
</div>
</div>

<div id="outline-container-org48f7ba3" class="outline-3">
<h3 id="org48f7ba3"><span class="section-number-3">1.3</span> Coding style</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li><a href="http://wiki.bash-hackers.org/scripting/style">http://wiki.bash-hackers.org/scripting/style</a></li>

<li><p>
<a href="https://google-styleguide.googlecode.com/svn/trunk/shell.xml">https://google-styleguide.googlecode.com/svn/trunk/shell.xml</a>
</p>

<p>
<code>variable_name</code> (preferred, <code>variableName</code> accepted) <br />
<code>function_name</code> <br />
<code>CONSTANT_NAME</code>
</p></li>
</ul>
</div>
</div>

<div id="outline-container-org91bfd34" class="outline-3">
<h3 id="org91bfd34"><span class="section-number-3">1.4</span> Prerequisites</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Clear</li>
<li>Diff</li>
<li>Iconv</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-org6c04ac8" class="outline-2">
<h2 id="org6c04ac8"><span class="section-number-2">2</span> Shell aliases</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org81d677a" class="outline-3">
<h3 id="org81d677a"><span class="section-number-3">2.1</span> Find all of the distinct file extensions in a folder hierarchy</h3>
<div class="outline-text-3" id="text-2-1">
<p>
Recursive version:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">alias</span> <span class="org-variable-name">file_ext</span>=$<span class="org-string">'find . -type f -name "*.*" | awk -F. \'</span>!a[$<span class="org-variable-name">NF</span>]++{print $<span class="org-variable-name">NF</span>}<span class="org-string">\''</span>
</pre>
</div>

<p>
Recursive version:
</p>

<div class="org-src-container">
<pre class="src src-shell">find . -type f | sed -e <span class="org-string">'s/.*\.//'</span> | sed -e <span class="org-string">'s/.*\///'</span> | sort -u
</pre>
</div>

<p>
If you want totals (how may times the extension was seen):
</p>

<div class="org-src-container">
<pre class="src src-shell">find . -type f | sed -e <span class="org-string">'s/.*\.//'</span> | sed -e <span class="org-string">'s/.*\///'</span> | sort | uniq -c | sort -rn
</pre>
</div>

<p>
Non-recursive (single folder):
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-keyword">for</span> f<span class="org-keyword"> in</span> *.*; <span class="org-keyword">do </span><span class="org-builtin">printf</span> <span class="org-string">"%s\n"</span> <span class="org-string">"${f##*.}"</span>; <span class="org-keyword">done</span> | sort -u
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org54ed5a4" class="outline-2">
<h2 id="org54ed5a4"><span class="section-number-2">3</span> Shell functions</h2>
<div class="outline-text-2" id="text-3">
<p>
Only use alphanumeric characters and the underscore for function names.
</p>
</div>

<div id="outline-container-orgd57b9ad" class="outline-3">
<h3 id="orgd57b9ad"><span class="section-number-3">3.1</span> Exit with an error</h3>
<div class="outline-text-3" id="text-3-1">
<p>
The exit status follows the conventions for programs such as <code>grep</code>, <code>cmp</code>, and
<code>diff</code>: it is 2 (or greater) if an error occurred.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">die</span> () {
    <span class="org-builtin">printf</span> <span class="org-string">"$(</span><span class="org-sh-quoted-exec">basename</span><span class="org-string"> $0): $@\n"</span> &gt; /dev/stderr
    <span class="org-keyword">exit</span> 2                              <span class="org-comment-delimiter"># </span><span class="org-comment">An error occurred.</span>
}
</pre>
</div>

<p>
<code>Die</code> <b>must be a function</b> so that the calling script does exit with an error.
</p>
</div>
</div>

<div id="outline-container-org00fdba9" class="outline-3">
<h3 id="org00fdba9"><span class="section-number-3">3.2</span> Check for executable files</h3>
<div class="outline-text-3" id="text-3-2">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">files_executables_p</span> () {
    <span class="org-keyword">for</span> x<span class="org-keyword"> in</span> $<span class="org-variable-name">@</span>
    <span class="org-keyword">do</span>
        <span class="org-builtin">command</span> -v $<span class="org-variable-name">x</span> &gt; /dev/null || die <span class="org-string">"$x not found."</span>
    <span class="org-keyword">done</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org555eb3a" class="outline-3">
<h3 id="org555eb3a"><span class="section-number-3">3.3</span> Check for Cygwin executable files</h3>
<div class="outline-text-3" id="text-3-3">
<p>
We sometimes have to check that the <code>PATH</code> is set right, so that Cygwin
executables (for example, <code>whoami</code> and <code>hostname</code>) are found before their Windows
counterpart &#x2013; to avoid problems of spurious <code>\r</code> added to the output.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">files_cygwin_executables_p</span> () {
    <span class="org-keyword">for</span> x<span class="org-keyword"> in</span> $<span class="org-variable-name">@</span>
    <span class="org-keyword">do</span>
        [ <span class="org-string">"$(</span><span class="org-sh-quoted-exec">command</span><span class="org-string"> -v $x)"</span> = <span class="org-string">"/usr/bin/$x"</span> ] <span class="org-sh-escaped-newline">\</span>
            || die <span class="org-string">"$x is not a Cygwin executable."</span>
    <span class="org-keyword">done</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org57f123d" class="outline-3">
<h3 id="org57f123d"><span class="section-number-3">3.4</span> Find the name of the parent process</h3>
<div class="outline-text-3" id="text-3-4">
<p>
The following is supposed to work on Linux, but doesn&rsquo;t on Cygwin.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">pname</span> () {
    ps -o <span class="org-variable-name">command</span>= -p $<span class="org-variable-name">PPID</span> | tail -n 1 | awk <span class="org-string">'{print $1}'</span> | awk -F/ <span class="org-string">'{print $NF}'</span>
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf9f342f" class="outline-3">
<h3 id="orgf9f342f"><span class="section-number-3">3.5</span> Find recent files</h3>
<div class="outline-text-3" id="text-3-5">
<p>
It recursively finds all files containing the pattern of the first argument
passed to the command (<code>fr &lt;pattern&gt;</code>) and sorts them with the most recent one
last.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">fr</span> () {
    find ./ -iname <span class="org-string">"*"</span>$<span class="org-variable-name">@</span><span class="org-string">"*"</span> -printf <span class="org-string">"%T@ %Td-%Tb-%TY %Tk:%TM %p\n"</span> | sort -n |
    cut -d <span class="org-string">" "</span> -f 2- | grep -i <span class="org-string">"$@"</span>;
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org08898f1" class="outline-2">
<h2 id="org08898f1"><span class="section-number-2">4</span> Shell scripts</h2>
<div class="outline-text-2" id="text-4">
</div>

<div id="outline-container-orgc46ed8b" class="outline-3">
<h3 id="orgc46ed8b"><span class="section-number-3">4.1</span> Send an email</h3>
<div class="outline-text-3" id="text-4-1">
<p>
Send a mail to one or more people.
</p>
</div>

<div id="outline-container-org478beaa" class="outline-4">
<h4 id="org478beaa"><span class="section-number-4">4.1.1</span> Name</h4>
<div class="outline-text-4" id="text-4-1-1">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">mail -- Send simple mail</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org7302838" class="outline-4">
<h4 id="org7302838"><span class="section-number-4">4.1.2</span> Synopsis</h4>
<div class="outline-text-4" id="text-4-1-2">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">Usage</span> ()
{
    cat &lt;&lt; EOF 1&gt;&amp;2
<span class="org-sh-heredoc">Usage: $CMD [-s SUBJECT] [-a ATTACHMENT]... [-c CC-ADDR] [-b BCC-ADDR] [-f FROM-ADDR] TO-ADDR</span>
<span class="org-sh-heredoc">Try '$CMD -h' for more information.</span>
<span class="org-sh-heredoc">EOF</span>
    <span class="org-keyword">exit</span> 2
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org11f7f92" class="outline-4">
<h4 id="org11f7f92"><span class="section-number-4">4.1.3</span> Description</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
Send an email using <code>mail</code>:
</p>

<div class="org-src-container">
<pre class="src src-shell">mail -s <span class="org-string">"Subject"</span> recipient@example.com &lt; /path/to/file
cat /path/to/file | mail -s <span class="org-string">"Subject"</span> recipient@example.com
<span class="org-builtin">echo</span> <span class="org-string">"Message"</span> | mail -s <span class="org-string">"Subject"</span> recipient@example.com
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfbfa55b" class="outline-4">
<h4 id="orgfbfa55b"><span class="section-number-4">4.1.4</span> Options</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
The following options shall be supported:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">Help</span> ()
{
    cat &lt;&lt; EOF
<span class="org-sh-heredoc">This is $CMD, version: 20190318.1544.</span>

<span class="org-sh-heredoc">Usage: $CMD [-s SUBJECT] [-a ATTACHMENT]... [-c CC-ADDR] [-b BCC-ADDR] [-f FROM-ADDR] TO-ADDR</span>
<span class="org-sh-heredoc">Send simple mail.</span>
<span class="org-sh-heredoc">Examples:</span>
<span class="org-sh-heredoc">    $CMD -s 'Disk failure' bill@example.com &lt; /tmp/message</span>
<span class="org-sh-heredoc">    print "This is the body." | $CMD -s 'Other subject' bill@example.com</span>

<span class="org-sh-heredoc">Options:</span>
<span class="org-sh-heredoc">  -s  Specify subject on command line</span>
<span class="org-sh-heredoc">  -a  Attach a file</span>
<span class="org-sh-heredoc">  -c  Send carbon copies to (comma separated) list of recipients</span>
<span class="org-sh-heredoc">  -b  Send blind carbon copies to (comma separated) list of recipients</span>
<span class="org-sh-heredoc">  -f  Set the From address</span>
<span class="org-sh-heredoc">  -h  Display this help and exit</span>
<span class="org-sh-heredoc">EOF</span>
    <span class="org-keyword">exit</span> 0
}
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb55e5c1" class="outline-4">
<h4 id="orgb55e5c1"><span class="section-number-4">4.1.5</span> Stdin</h4>
<div class="outline-text-4" id="text-4-1-5">
<p>
When <code>mail</code> is invoked, standard input shall be the message to be delivered to
the specified addresses.
</p>
</div>
</div>

<div id="outline-container-orga18abb8" class="outline-4">
<h4 id="orga18abb8"><span class="section-number-4">4.1.6</span> Input files</h4>
<div class="outline-text-4" id="text-4-1-6">
<p>
None.
</p>
</div>
</div>

<div id="outline-container-orgdae32c6" class="outline-4">
<h4 id="orgdae32c6"><span class="section-number-4">4.1.7</span> Environment variables</h4>
<div class="outline-text-4" id="text-4-1-7">
<p>
The behavior of <code>mail</code> is affected by the following environment variable:
</p>

<dl class="org-dl">
<dt><code>SMTP</code></dt><dd>The SMTP connection is made to the server specified by the variable <code>SMTP</code>.</dd>
</dl>
</div>
</div>

<div id="outline-container-org24e0f85" class="outline-4">
<h4 id="org24e0f85"><span class="section-number-4">4.1.8</span> Stdout</h4>
<div class="outline-text-4" id="text-4-1-8">
<p>
The standard output shall be that of the <code>blat</code> command.
</p>
</div>
</div>

<div id="outline-container-org8c52c90" class="outline-4">
<h4 id="org8c52c90"><span class="section-number-4">4.1.9</span> Stderr</h4>
<div class="outline-text-4" id="text-4-1-9">
<p>
The standard error shall be used only for diagnostic messages.
</p>
</div>
</div>

<div id="outline-container-orge015f88" class="outline-4">
<h4 id="orge015f88"><span class="section-number-4">4.1.10</span> Output files</h4>
<div class="outline-text-4" id="text-4-1-10">
<p>
None.
</p>
</div>
</div>

<div id="outline-container-org6e4b41a" class="outline-4">
<h4 id="org6e4b41a"><span class="section-number-4">4.1.11</span> Exit status</h4>
<div class="outline-text-4" id="text-4-1-11">
<p>
The <code>mail</code> utility returns one of the following values upon exit:
</p>

<dl class="org-dl">
<dt>0</dt><dd>Successful completion: one mail was sent.</dd>

<dt>2</dt><dd>Invalid options were specified on the command line or shell input was
missing.</dd>
</dl>

<p>
Otherwise, the exit status of <code>mail</code> shall be that of the <code>blat</code> command.
</p>
</div>
</div>

<div id="outline-container-org5852ab5" class="outline-4">
<h4 id="org5852ab5"><span class="section-number-4">4.1.12</span> Examples</h4>
<div class="outline-text-4" id="text-4-1-12">
<p>
Here&rsquo;s a shell script that reports the disk usage:
</p>

<div class="org-src-container">
<pre class="src src-shell">( <span class="org-builtin">printf</span> <span class="org-string">"Disk usage:\n"</span> ; du -sh ) | mail -s <span class="org-string">"Disk usage report"</span> recipient@example.com
</pre>
</div>

<p>
Here&rsquo;s another one to backup a configuration folder, archive it, and send it as
an attachment:
</p>

<div class="org-src-container">
<pre class="src src-shell">tar -zcf ~/backup.tar.gz ~/files_to_backup
<span class="org-builtin">printf</span> <span class="org-string">"Archived configuration files\n"</span> | mail -s <span class="org-string">"Backup data"</span> -a ~/backup.tar.gz recipient@example.com
</pre>
</div>
</div>
</div>

<div id="outline-container-org8797df8" class="outline-4">
<h4 id="org8797df8"><span class="section-number-4">4.1.13</span> Code</h4>
<div class="outline-text-4" id="text-4-1-13">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">command name</span>
<span class="org-variable-name">CMD</span>=$(<span class="org-sh-quoted-exec">basename</span> $<span class="org-variable-name">0</span>)

<span class="org-builtin">.</span> shellutils || <span class="org-keyword">exit</span> 2

<span class="org-keyword">if</span> [ $<span class="org-variable-name">#</span> -eq 0 ]; <span class="org-keyword">then</span>
    Usage
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">check for Cygwin executable files (and not their Windows counterpart)</span>
files_cygwin_executables_p <span class="org-string">"whoami"</span> <span class="org-string">"hostname"</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">default values</span>
<span class="org-variable-name">SUBJECT</span>=<span class="org-string">"none"</span>
<span class="org-variable-name">ATTFILES</span>=<span class="org-string">""</span>                             <span class="org-comment-delimiter"># </span><span class="org-comment">files to be attached</span>
<span class="org-variable-name">CC</span>=<span class="org-string">""</span>
<span class="org-variable-name">BCC</span>=<span class="org-string">""</span>
<span class="org-variable-name">FROM</span>=<span class="org-string">"&lt;$(</span><span class="org-sh-quoted-exec">whoami</span><span class="org-string">)@$(</span><span class="org-sh-quoted-exec">echo</span><span class="org-string"> $(</span><span class="org-sh-quoted-exec">hostname</span><span class="org-string">).com | tr '[:upper:]' '[:lower:]')&gt;"</span>
: ${<span class="org-variable-name">SMTP</span>:=<span class="org-string">"smtp"</span>}                       <span class="org-comment-delimiter"># </span><span class="org-comment">set var if not already set</span>
<span class="org-variable-name">BODY</span>=<span class="org-string">"--"</span>                               <span class="org-comment-delimiter"># </span><span class="org-comment">stdin.txt</span>

<span class="org-keyword">while </span><span class="org-builtin">getopts</span> <span class="org-string">"s:c:b:f:a:h"</span> opt
<span class="org-keyword">do</span>
    <span class="org-keyword">case</span> <span class="org-string">"$opt"</span><span class="org-keyword"> in</span>
        s) <span class="org-variable-name">SUBJECT</span>=<span class="org-string">"$OPTARG"</span>;;
        a) <span class="org-variable-name">ATTFILES</span>=<span class="org-string">"$ATTFILES $OPTARG"</span>;;
        c) <span class="org-variable-name">CC</span>=<span class="org-string">"$OPTARG"</span>;;
        b) <span class="org-variable-name">BCC</span>=<span class="org-string">"$OPTARG"</span>;;
        f) <span class="org-variable-name">FROM</span>=<span class="org-string">"$OPTARG"</span>;;
        h) Help;;
        *) Usage;;
    <span class="org-keyword">esac</span>
<span class="org-keyword">done</span>
<span class="org-builtin">shift</span> $(($<span class="org-variable-name">OPTIND</span> - 1))

<span class="org-variable-name">MAILTO</span>=<span class="org-string">"$1"</span>
<span class="org-keyword">if</span> [ <span class="org-string">"$MAILTO"</span> = <span class="org-string">""</span> ]; <span class="org-keyword">then</span>
    Usage
<span class="org-keyword">fi</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">check presence of stdin contents</span>
[ -t 0 ] &amp;&amp; die <span class="org-string">"Message body is missing."</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">check for executable files</span>
files_executables_p <span class="org-string">"blat"</span>

<span class="org-variable-name">ATT_SWITCH</span>=<span class="org-string">""</span>
<span class="org-keyword">for</span> attach<span class="org-keyword"> in</span> $<span class="org-variable-name">ATTFILES</span>
<span class="org-keyword">do</span>
    <span class="org-keyword">if</span> [ <span class="org-negation-char">!</span> -r $<span class="org-variable-name">attach</span> ]
    <span class="org-keyword">then</span>
        die <span class="org-string">"File $attach does not exist or is not readable."</span>
    <span class="org-keyword">else</span>
        <span class="org-comment-delimiter"># </span><span class="org-comment">binary vs text file</span>
        <span class="org-keyword">if</span> [ <span class="org-string">"$(</span><span class="org-sh-quoted-exec">file</span><span class="org-string"> --brief --mime $attach 2&gt; /dev/null | cut -d/ -f 1)"</span> = <span class="org-string">"text"</span> ]
        <span class="org-keyword">then</span>
            <span class="org-variable-name">ATT_SWITCH</span>=<span class="org-string">"$ATT_SWITCH -attacht $(</span><span class="org-sh-quoted-exec">cygpath</span><span class="org-string"> -w $attach)"</span>
        <span class="org-keyword">else</span>
            <span class="org-variable-name">ATT_SWITCH</span>=<span class="org-string">"$ATT_SWITCH -attach $(</span><span class="org-sh-quoted-exec">cygpath</span><span class="org-string"> -w $attach)"</span>
        <span class="org-keyword">fi</span>
    <span class="org-keyword">fi</span>
<span class="org-keyword">done</span>

<span class="org-variable-name">CC_SWITCH</span>=<span class="org-string">""</span>
[ <span class="org-string">"$CC"</span> = <span class="org-string">""</span> ] || <span class="org-variable-name">CC_SWITCH</span>=<span class="org-string">"-cc ${CC}"</span>

<span class="org-variable-name">BCC_SWITCH</span>=<span class="org-string">""</span>
[ <span class="org-string">"$BCC"</span> = <span class="org-string">""</span> ] || <span class="org-variable-name">BCC_SWITCH</span>=<span class="org-string">"-bcc ${BCC}"</span>

blat -to <span class="org-string">"$MAILTO"</span> <span class="org-sh-escaped-newline">\</span>
     $<span class="org-variable-name">CC_SWITCH</span> <span class="org-sh-escaped-newline">\</span>
     $<span class="org-variable-name">BCC_SWITCH</span> <span class="org-sh-escaped-newline">\</span>
     -subject <span class="org-string">"$SUBJECT"</span> <span class="org-sh-escaped-newline">\</span>
     -f <span class="org-string">"$FROM"</span> <span class="org-sh-escaped-newline">\</span>
     -server <span class="org-string">"$SMTP"</span> <span class="org-sh-escaped-newline">\</span>
     $<span class="org-variable-name">ATT_SWITCH</span>

<span class="org-comment-delimiter"># </span><span class="org-comment">mail ends here</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org5d01694" class="outline-3">
<h3 id="org5d01694"><span class="section-number-3">4.2</span> Echo text in color</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-function-name">cecho</span> () {
    <span class="org-variable-name">black</span>=<span class="org-string">"\e[30m"</span>
    <span class="org-variable-name">red</span>=<span class="org-string">"\e[31m"</span>
    <span class="org-variable-name">green</span>=<span class="org-string">"\e[32m"</span>
    <span class="org-variable-name">yellow</span>=<span class="org-string">"\e[33m"</span>
    <span class="org-variable-name">blue</span>=<span class="org-string">"\e[34m"</span>
    <span class="org-variable-name">magenta</span>=<span class="org-string">"\e[35m"</span>
    <span class="org-variable-name">cyan</span>=<span class="org-string">"\e[36m"</span>
    <span class="org-variable-name">white</span>=<span class="org-string">"\e[37m"</span>

    <span class="org-variable-name">BLACK</span>=<span class="org-string">"\e[1;30m"</span>
    <span class="org-variable-name">RED</span>=<span class="org-string">"\e[1;31m"</span>
    <span class="org-variable-name">GREEN</span>=<span class="org-string">"\e[1;32m"</span>
    <span class="org-variable-name">YELLOW</span>=<span class="org-string">"\e[1;33m"</span>
    <span class="org-variable-name">BLUE</span>=<span class="org-string">"\e[1;34m"</span>
    <span class="org-variable-name">MAGENTA</span>=<span class="org-string">"\e[1;35m"</span>
    <span class="org-variable-name">CYAN</span>=<span class="org-string">"\e[1;36m"</span>
    <span class="org-variable-name">WHITE</span>=<span class="org-string">"\e[1;37m"</span>

    <span class="org-variable-name">reset</span>=<span class="org-string">"\e[0m"</span>

    <span class="org-variable-name">color</span>=${<span class="org-variable-name">YELLOW</span>}
    <span class="org-builtin">printf</span> <span class="org-string">"$color$1$reset\n"</span>
}

cecho <span class="org-string">"$@"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org21baa08" class="outline-3">
<h3 id="org21baa08"><span class="section-number-3">4.3</span> Find duplicates</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org4c97ed4" class="outline-4">
<h4 id="org4c97ed4"><span class="section-number-4">4.3.1</span> finddup &#x2013; find DUPlicate files</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
Use <code>fdupes</code> (from Cygwin).
</p>

<div class="org-src-container">
<pre class="src src-shell">fdupes -r . <span class="org-sh-escaped-newline">\</span>
    | grep -v <span class="org-string">"/.svn/"</span> <span class="org-sh-escaped-newline">\</span>
    | grep -v <span class="org-string">"/.git/"</span> <span class="org-sh-escaped-newline">\</span>
    | grep -v <span class="org-string">"/.gitkeep"</span> <span class="org-sh-escaped-newline">\</span>
    | grep -v <span class="org-string">"/.emacs.d/backups"</span> <span class="org-sh-escaped-newline">\</span>
    | uniq
    | awk <span class="org-string">'BEGIN {RS="\n\n"; ORS="\n\n"; FS="\n"} {if (NF&gt;1) print}'</span>
</pre>
</div>

<div class="note">
<p>
<code>uniq</code> deletes duplicate, consecutive lines.
</p>

<p>
The AWK script finds every block with more than one line.
</p>

</div>
</div>
</div>

<div id="outline-container-org756c2af" class="outline-4">
<h4 id="org756c2af"><span class="section-number-4">4.3.2</span> findsn &#x2013; find Same Name (problems with clashing names)</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
find (files) with duplicate or conflicting names.
Usage: findsn [-A -c -C] [[-r] [-f] paths(s) &#x2026;]
</p>

<div class="org-src-container">
<pre class="src src-shell">find . -type f | sort | uniq -c | grep -v <span class="org-string">"^[ \t]*1 "</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/usr/bin/</span><span class="org-keyword">env</span><span class="org-comment"> bash</span>

find -type f &gt; names.lst

&gt; names.out

<span class="org-variable-name">TAB</span>=<span class="org-sh-quoted-exec">`echo -ne "\t"`</span>
<span class="org-keyword">while </span><span class="org-builtin">read</span> name
<span class="org-keyword">do</span>
    <span class="org-variable-name">bn</span>=<span class="org-string">"$( basename "$name" )"</span>
    <span class="org-variable-name">name2</span>=<span class="org-string">"$( grep "$bn" names.lst | grep -v "$name" )"</span>
    <span class="org-keyword">if</span> [ <span class="org-string">"$name2"</span> != <span class="org-string">""</span> ]
    <span class="org-keyword">then</span>
                        <span class="org-keyword">if</span> <span class="org-negation-char">!</span>(grep -q <span class="org-string">"^${name}${TAB}"</span> names.out); <span class="org-keyword">then</span>
                                <span class="org-variable-name">size</span>=<span class="org-sh-quoted-exec">`stat --format=%s "$name"`</span>
                                <span class="org-variable-name">size2</span>=<span class="org-sh-quoted-exec">`stat --format=%s "$name2"`</span>
                                <span class="org-builtin">echo</span> -e <span class="org-string">"$name${TAB}$size"</span> &gt;&gt; names.out
                                <span class="org-builtin">echo</span> -e <span class="org-string">"$name2${TAB}$size"</span> &gt;&gt; names.out
                        <span class="org-keyword">fi</span>
    <span class="org-keyword">fi</span>
<span class="org-keyword">done</span> &lt; names.lst

cat names.out
rm -f names.lst
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Find Duplicate File Names - By Dev (dk_mahadeva@yahoo.com)</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">If no command-line parameter (path to begin from) is specified, then the</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">default is to begin from the current (.) directory.</span>
<span class="org-builtin">cd</span> <span class="org-variable-name">path</span>=$<span class="org-variable-name">1</span>
: ${<span class="org-variable-name">path</span>:=.}
<span class="org-builtin">printf</span> <span class="org-string">"Building file list...\n"</span> &gt; /dev/stderr
<span class="org-variable-name">fullList</span>=$(<span class="org-sh-quoted-exec">find</span> <span class="org-sh-quoted-exec">`pwd`</span> $<span class="org-variable-name">path</span> | grep -v <span class="org-string">'^\.'</span> | awk -F <span class="org-string">'/'</span> <span class="org-string">'{print $NF,$0}'</span> | sort +0 -1)
<span class="org-variable-name">fileNames</span>=$(<span class="org-sh-quoted-exec">find</span> <span class="org-sh-quoted-exec">`pwd`</span> $<span class="org-variable-name">path</span> | grep -v <span class="org-string">'^\.'</span> | awk -F <span class="org-string">'/'</span> <span class="org-string">'{print $NF}'</span> | sort | uniq -d)
<span class="org-keyword">for</span> EACH<span class="org-keyword"> in</span> $<span class="org-variable-name">fileNames</span>; <span class="org-keyword">do</span>
    <span class="org-builtin">echo</span> <span class="org-string">"$fullList"</span> | grep -wE <span class="org-string">"^$EACH "</span>
    <span class="org-builtin">echo</span> <span class="org-string">""</span>
<span class="org-keyword">done</span>
<span class="org-keyword">exit</span> 0
</pre>
</div>
</div>
</div>

<div id="outline-container-org37d9fe4" class="outline-4">
<h4 id="org37d9fe4"><span class="section-number-4">4.3.3</span> grep2 &#x2013; Find all AXVW files with two strings (Show AXVW files with both matches only)</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
(See Utilities.)
</p>
</div>
</div>
</div>

<div id="outline-container-orgb60960a" class="outline-3">
<h3 id="orgb60960a"><span class="section-number-3">4.4</span> Utils</h3>
<div class="outline-text-3" id="text-4-4">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Strip lines with dashes.</span>
sed <span class="org-string">"s/NULL//g"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Delete the second line.</span>
sed -e <span class="org-string">'2d'</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Replace NULL value by empty string.</span>
sed <span class="org-string">"s/NULL//g"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org38c5c9a" class="outline-2">
<h2 id="org38c5c9a"><span class="section-number-2">5</span> Findup</h2>
<div class="outline-text-2" id="text-5">
<p>
Search for the specified file(s) in the directory tree upwards, up to <code>/</code>.
</p>

<p>
Usage:
</p>
<pre class="example">
findup -name 'x*'
</pre>


<div class="org-src-container">
<pre class="src src-shell"><span class="org-builtin">set</span> -e
<span class="org-keyword">while</span> [[ $<span class="org-variable-name">PWD</span> != / ]]; <span class="org-keyword">do</span>
    find <span class="org-string">"$PWD"</span>/ -maxdepth 1 -mindepth 1 <span class="org-string">"$@"</span>
    <span class="org-builtin">cd</span> ..
<span class="org-keyword">done</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb346e2d" class="outline-2">
<h2 id="orgb346e2d"><span class="section-number-2">6</span> Compare two files and print unmatched lines / Deleting lines from one file which are in another file</h2>
<div class="outline-text-2" id="text-6">
<p>
Remove the lines from file which appear in another file.
</p>
</div>

<div id="outline-container-org06b15bf" class="outline-3">
<h3 id="org06b15bf"><span class="section-number-3">6.1</span> Comm</h3>
<div class="outline-text-3" id="text-6-1">
<p>
Compare two <b>sorted</b> files line by line.
</p>

<ul class="org-ul">
<li><code>-1</code> removes all lines unique to <code>file1</code>,</li>
<li><code>-2</code> removes all lines that are only in <code>file2</code> and</li>
<li><code>-3</code> removes all lines that are <b>common</b> in both files.</li>
</ul>

<p>
The <code>comm</code> (with <code>sort</code>) method take a long time on large files.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Print lines in file1 not in file2, and vice versa.</span>
comm -3 &lt;(sort file1) &lt;(sort file2)
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Print unmatched lines.</span>
$ comm -13 &lt;(sort file1) &lt;(sort file2)
<span class="org-comment-delimiter"># </span><span class="org-comment">Suppress the lines that are in both files, or only in file1.</span>
</pre>
</div>

<p>
<b>Remove the lines from file <code>from-this.txt</code> *which appear in file <code>exclude-these.txt</code>.</b>
No cleanup needed!
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Clear redundant contents in from-this.txt.</span>
comm -23 from-this.txt exclude-these.txt | sponge from-this.txt
</pre>
</div>
</div>
</div>

<div id="outline-container-org1486111" class="outline-3">
<h3 id="org1486111"><span class="section-number-3">6.2</span> AWK</h3>
<div class="outline-text-3" id="text-6-2">
<p>
Alternatively, an AWK solution to remove common lines between 2 files without
sorting &#x2013; <b>much faster</b> than <code>sort</code>, and keeps the original order of the
<code>from-this.txt</code> file:
</p>

<div class="org-src-container">
<pre class="src src-shell">awk <span class="org-string">'NR == FNR { a[$0]++; next } { if (! a[$0]) print }'</span> exclude-these.txt from-this.txt
</pre>
</div>

<div class="note">
<p>
In Awk, <code>FNR</code> refers to the record number (typically the line number) in the
current file and <code>NR</code> refers to the total record number.  This means that the
condition <code>NR==FNR</code> is only true for the first file, as <code>FNR</code> resets back to 1 for
the first line of each file but <code>NR</code> keeps on increasing.
</p>

<p>
This pattern is typically used to perform actions on only the first file.  The
next inside the block means any further commands are skipped, so they are only
run on files other than the first.
</p>

</div>

<p>
If you&rsquo;re doing this with huge files, then the <b>memory constraints</b> of loading
a huge file into an associative array are going to be prohibitive.
</p>
</div>
</div>

<div id="outline-container-org751e7c8" class="outline-3">
<h3 id="org751e7c8"><span class="section-number-3">6.3</span> Diff</h3>
<div class="outline-text-3" id="text-6-3">
<p>
The downside of the above solutions is that it doesn&rsquo;t take line order into
account and, if your input has duplicate lines in different places, you might
not get what you expect.
</p>

<p>
The solution to that is to use a real comparison tool such as <code>diff</code>.  You could
do this by creating a diff file with the context value at 100% of the lines in
the file, then parsing it for just the lines that would be removed if converting
file <code>from-this.txt</code> to file <code>exclude-these.txt</code>.  <i>(This command also removes the
diff formatting after it gets the right lines.)</i>
</p>

<div class="org-src-container">
<pre class="src src-shell">diff -U $(<span class="org-sh-quoted-exec">wc</span> -l &lt; from-this.txt) from-this.txt exclude-these.txt | sed -n <span class="org-string">'s/^-//p'</span>
</pre>
</div>

<p>
Example:
</p>

<div class="org-src-container">
<pre class="src src-shell">awk <span class="org-string">'NR == FNR { a[$0]++; next } { if (! a[$0]) print }'</span> dupes-standard.txt dupes-custo.txt
diff -U $(<span class="org-sh-quoted-exec">wc</span> -l &lt; dupes-custo.txt) dupes-custo.txt dupes-standard.txt | sed -n <span class="org-string">'s/^-//p'</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1c3a97c" class="outline-2">
<h2 id="org1c3a97c"><span class="section-number-2">7</span> Recursively run chmod -x?</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org550e37a" class="outline-3">
<h3 id="org550e37a"><span class="section-number-3">7.1</span> Convert the files with 755 permissions to 644</h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-sh">find . -type f -perm 755 -exec chmod 644 {} <span class="org-string">\;</span>
</pre>
</div>

<div class="note">
<p>
You could use <code>+</code> instead of <code>\;</code> to reduce the number of subprocesses created.
</p>

</div>
</div>
</div>

<div id="outline-container-orgfca50d3" class="outline-3">
<h3 id="orgfca50d3"><span class="section-number-3">7.2</span> Pictures, etc.</h3>
<div class="outline-text-3" id="text-7-2">
<p>
There is no (good) reason ever for pictures to be executable.
</p>

<p>
Just run this command to fix them:
</p>

<div class="org-src-container">
<pre class="src src-sh"><span class="org-comment-delimiter"># </span><span class="org-comment">find /space/music -name "*.jpg" -exec chmod -x {} +</span>

<span class="org-builtin">echo</span> <span class="org-string">"Remove exe perm"</span>
find . -name <span class="org-string">"*.DTD"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.R"</span>         -exec chmod -x {} +
find . -name <span class="org-string">"*.Txt"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.VWAPFLOW"</span>  -exec chmod -x {} +
find . -name <span class="org-string">"*.VWPPFLOW"</span>  -exec chmod -x {} +
find . -name <span class="org-string">"*.asa"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.asp"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.css"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.csv"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.dtd"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.gif"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.gitignore"</span> -exec chmod -x {} +
find . -name <span class="org-string">"*.htm"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.html"</span>      -exec chmod -x {} +
find . -name <span class="org-string">"*.idx"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.m"</span>         -exec chmod -x {} +
find . -name <span class="org-string">"*.md5"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.org"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.pack"</span>      -exec chmod -x {} +
find . -name <span class="org-string">"*.pdf"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.pid"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.png"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.sample"</span>    -exec chmod -x {} +
find . -name <span class="org-string">"*.sql"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.tex"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.txt"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.xls"</span>       -exec chmod -x {} +
find . -name <span class="org-string">"*.xml"</span>       -exec chmod -x {} +
</pre>
</div>

<p>
Bonus:
</p>

<div class="org-src-container">
<pre class="src src-sh">find /space/music -type d -exec chmod o-w {} +
find /space/music -type d -exec chmod 755 {} +
</pre>
</div>

<p>
Explanation:
</p>

<p>
Most of the command line is self-explanatory. The only part that need some
insight is the ending. <code>{}</code> is replaced by the name of the files (resp directory)
found that match the filter. Usually, the find command is ended with a protected
semicolon <code>\;</code>.
</p>

<p>
However, this isn&rsquo;t efficient as the command is run once for each
file/directory.
</p>

<p>
There is a well known workaround that pipes <code>find</code> output to <code>xargs</code> which
concatenates the file names up to the maximum command line allowed but then
there is an issue when the path contains spaces, which is more and more common
even in the Unix/Linux world.
</p>

<p>
Again a workaround based on GNU specific extensions allows to properly handle
these case. I choose a simpler approach using a POSIX (read portable) way to
have find building itself the long command lines, i.e. <code>{}</code> is replaced by a suite
of file names up to the maximum number allowed.
</p>
</div>
</div>
</div>

<div id="outline-container-org55a75ba" class="outline-2">
<h2 id="org55a75ba"><span class="section-number-2">8</span> VC</h2>
<div class="outline-text-2" id="text-8">
<p>
<a href="http://superuser.com/questions/44787/looping-through-subdirectories-and-running-a-command-in-each">http://superuser.com/questions/44787/looping-through-subdirectories-and-running-a-command-in-each</a>
</p>

<div class="org-src-container">
<pre class="src src-shell" id="orgff7a399"><span class="org-keyword">for</span> dir<span class="org-keyword"> in</span> ~/src/*
<span class="org-keyword">do</span>
    cecho <span class="org-string">"Updating $dir:"</span>
    <span class="org-keyword">if</span> [ -d $<span class="org-variable-name">dir</span>/.git ]; <span class="org-keyword">then</span>
        (<span class="org-builtin">cd</span> $<span class="org-variable-name">dir</span> &amp;&amp; git pull)
    <span class="org-keyword">elif</span> [ -d $<span class="org-variable-name">dir</span>/.svn ]; <span class="org-keyword">then</span>
        (<span class="org-builtin">cd</span> $<span class="org-variable-name">dir</span> &amp;&amp; svn update)
    <span class="org-keyword">fi</span>
    <span class="org-builtin">printf</span> <span class="org-string">"\n"</span>
<span class="org-keyword">done</span>
</pre>
</div>

<p>
If you need it to be recursive:
</p>

<div class="org-src-container">
<pre class="src src-shell" id="org100c9e3">find -type d -printf <span class="org-string">"%f"</span> -exec  sh -c <span class="org-string">"cd \"{}\" &amp;&amp; git pull"</span>  <span class="org-string">\;</span>
</pre>
</div>

<p>
See <a href="http://snipplr.com/view/6228/recursively-find-subversion-working-copies-and-update/">http://snipplr.com/view/6228/recursively-find-subversion-working-copies-and-update/</a>
</p>
</div>

<div id="outline-container-orgd2812ff" class="outline-3">
<h3 id="orgd2812ff"><span class="section-number-3">8.1</span> Ignore files from the command line</h3>
<div class="outline-text-3" id="text-8-1">
<p>
Add a file (or a file glob pattern) to ignore without deleting the previous
value of the <code>svn:ignore</code> property&#x2026; from the command line.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter"># </span><span class="org-comment">Usage: svnignore admin/notes/\*.tex</span>

<span class="org-variable-name">target</span>=<span class="org-string">"$1"</span>
<span class="org-variable-name">targetdirectory</span>=$(<span class="org-sh-quoted-exec">dirname</span> $<span class="org-variable-name">target</span>)
<span class="org-variable-name">targetfilepattern</span>=$(<span class="org-sh-quoted-exec">basename</span> $<span class="org-variable-name">target</span>)

<span class="org-variable-name">svnignores</span>=$(<span class="org-sh-quoted-exec">svn</span> propget svn:ignore <span class="org-string">"$targetdirectory"</span>)
<span class="org-variable-name">svnignores</span>=<span class="org-string">"$svnignores"</span>$<span class="org-string">'\n'"$targetfilepattern"</span>
<span class="org-builtin">printf</span> <span class="org-string">"Ignore '$targetfilepattern'\n"</span>
svn propset svn:ignore <span class="org-string">"$svnignores"</span> <span class="org-string">"$targetdirectory"</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org63419b9" class="outline-2">
<h2 id="org63419b9"><span class="section-number-2">9</span> Web security assessments</h2>
<div class="outline-text-2" id="text-9">
</div>
<div id="outline-container-org4b8ee2d" class="outline-3">
<h3 id="org4b8ee2d"><span class="section-number-3">9.1</span> HTTP</h3>
<div class="outline-text-3" id="text-9-1">
<p>
From Hacking Exposed Web Applications:
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">mike's getit.sh script</span>
<span class="org-keyword">if</span> [ -z $<span class="org-variable-name">1</span> ]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> -e <span class="org-string">"\n\tUsage: $0 &lt;host&gt; &lt;URL&gt;"</span>
    <span class="org-keyword">exit</span>
<span class="org-keyword">fi</span>
<span class="org-builtin">echo</span> -e <span class="org-string">"GET $2 HTTP/1.0\n\n"</span> | <span class="org-sh-escaped-newline">\</span>
nc -vv $<span class="org-variable-name">1</span> 80
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">getit.sh www.missioncriticalit.com /index.html
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">getit.sh www.victim.com /index.html | grep -i <span class="org-string">"&lt;form"</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">getit.sh www.victim.com /index.html | grep -i <span class="org-string">"input type"</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org5e8a7a8" class="outline-3">
<h3 id="org5e8a7a8"><span class="section-number-3">9.2</span> HTTPS</h3>
<div class="outline-text-3" id="text-9-2">
<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">mike's sgetit.sh script</span>
<span class="org-keyword">if</span> [ -z $<span class="org-variable-name">1</span> ]; <span class="org-keyword">then</span>
    <span class="org-builtin">echo</span> -e <span class="org-string">"\n\tUsage: $0 &lt;SSL host&gt; &lt;URL&gt;"</span>
    <span class="org-keyword">exit</span>
<span class="org-keyword">fi</span>
<span class="org-builtin">echo</span> -e <span class="org-string">"GET $2 HTTP/1.0\n\n"</span> | <span class="org-sh-escaped-newline">\</span>
openssl s_client -quiet -connect $<span class="org-variable-name">1</span>:443 2&gt;/dev/null
</pre>
</div>

<div class="org-src-container">
<pre class="src src-shell">sgetit.sh www.victim.com /secure/admin.html
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org3ce6e0d" class="outline-2">
<h2 id="org3ce6e0d"><span class="section-number-2">10</span> Netcat</h2>
<div class="outline-text-2" id="text-10">
<p>
Here is a script which will port scan and banner grab automatically with
netcat. It will check for the SSH and MySQL version by connecting and saving
the results and it will see if the HTTP server is vulnerable to the <code>TRACE</code>
method, look in the dumpfile <code>/tmp/bannergrab</code> and look for
<code>&lt;script&gt;alert(123)&lt;/script&gt;</code> if you can find that back you got yourself a
vulnerable server.
</p>

<div class="org-src-container">
<pre class="src src-shell"><span class="org-comment-delimiter">#</span><span class="org-comment">!/bin/</span><span class="org-keyword">sh</span>

<span class="org-variable-name">range</span>=<span class="org-string">"10.10.10."</span>;

<span class="org-comment-delimiter"># </span><span class="org-comment">You can change this to a port range $(</span><span class="org-sh-quoted-exec">seq</span><span class="org-comment"> 20 25) is port 20-25</span>
<span class="org-variable-name">ports</span>=<span class="org-string">"20 21 22 23 25 53 80 110 111 443 3306 6000"</span>;

<span class="org-variable-name">http_header</span>=<span class="org-string">"HEAD / HTTP/0.1\n\n"</span>;

<span class="org-keyword">for</span> host<span class="org-keyword"> in</span> $(<span class="org-sh-quoted-exec">seq</span> 2 254); <span class="org-keyword">do</span>
    <span class="org-keyword">for</span> port<span class="org-keyword"> in</span> $<span class="org-variable-name">ports</span>; <span class="org-keyword">do</span>
        <span class="org-builtin">echo</span> <span class="org-string">"[+] Testing "</span>$<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span><span class="org-string">":"</span>$<span class="org-variable-name">port</span>;
        <span class="org-variable-name">result</span>=$(<span class="org-sh-quoted-exec">nc</span> -zv -w 1 $<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span> $<span class="org-variable-name">port</span> 2&gt;&amp;1 | grep succeeded);
        <span class="org-keyword">if</span> [ -n <span class="org-string">"$result"</span> ]; <span class="org-keyword">then</span>
            <span class="org-builtin">echo</span> <span class="org-string">"\n"</span>$<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span><span class="org-string">":"</span>$<span class="org-variable-name">port</span><span class="org-string">"\n"</span> &gt;&gt; <span class="org-string">"/tmp/bannergrab"</span>
            <span class="org-keyword">if</span> [ <span class="org-string">"$port"</span> -eq <span class="org-string">"22"</span> ]; <span class="org-keyword">then</span>
                <span class="org-builtin">echo</span> <span class="org-string">"Found open port "</span>$<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span><span class="org-string">":"</span>$<span class="org-variable-name">port</span><span class="org-string">" Here might be some SSH server, it echoes the SSH version to you on connecting when lucky."</span>;
                nc -v -w 1 $<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span> $<span class="org-variable-name">port</span> &gt;&gt; <span class="org-string">"/tmp/bannergrab"</span>;
            <span class="org-keyword">fi</span>;
            <span class="org-keyword">if</span> [ <span class="org-string">"$port"</span> -eq <span class="org-string">"80"</span> ]; <span class="org-keyword">then</span>
                <span class="org-builtin">echo</span> <span class="org-string">"Found open port "</span>$<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span><span class="org-string">":"</span>$<span class="org-variable-name">port</span><span class="org-string">" Trying to fingerprint with HEAD and see if the server is vulnerable to TRACE XSSing"</span>;
                <span class="org-builtin">echo</span> $<span class="org-variable-name">http_header</span> | nc -v -w 1 $<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span> $<span class="org-variable-name">port</span> &gt;&gt; <span class="org-string">"/tmp/bannergrab"</span>
                <span class="org-builtin">echo</span> <span class="org-string">"TRACE / HTTP/1.1\nHost: $range$host\nuser-agent: &lt;script&gt;alert(123)&lt;/script&gt;\n\n"</span> | nc -v -w 2 $<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span> $<span class="org-variable-name">port</span> &gt;&gt; <span class="org-string">"/tmp/bannergrab"</span>
            <span class="org-keyword">fi</span>;
            <span class="org-keyword">if</span> [ <span class="org-string">"$port"</span> -eq <span class="org-string">"3306"</span> ]; <span class="org-keyword">then</span>
                <span class="org-builtin">echo</span> <span class="org-string">"Found open port "</span>$<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span><span class="org-string">":"</span>$<span class="org-variable-name">port</span><span class="org-string">" Possible MySQL installation found, saving the banner for later inspection, the MySQL version can be found in this."</span>;
                nc -v -w 1 $<span class="org-variable-name">range</span>$<span class="org-variable-name">host</span> $<span class="org-variable-name">port</span> &gt;&gt; <span class="org-string">"/tmp/bannergrab"</span>;
            <span class="org-keyword">fi</span>;
        <span class="org-keyword">fi</span>;
    <span class="org-keyword">done</span>
<span class="org-keyword">done</span>
</pre>
</div>

<p>
A lot more on <a href="http://h.ackack.net/cheatsheets/netcat/">http://h.ackack.net/cheatsheets/netcat/</a>: how to workaround <code>-e
cmd.exe</code> option which disappeared, etc.
</p>
</div>

<div id="outline-container-org0938781" class="outline-3">
<h3 id="org0938781"><span class="section-number-3">10.1</span> Scan only certain ports</h3>
<div class="outline-text-3" id="text-10-1">
<div class="org-src-container">
<pre class="src src-shell">nc -z -w 1 -v -v 10.10.10.11 20-30,53,80,100-112,443,6000-6050
</pre>
</div>
</div>
</div>

<div id="outline-container-orga8382c7" class="outline-3">
<h3 id="orga8382c7"><span class="section-number-3">10.2</span> DNS</h3>
<div class="outline-text-3" id="text-10-2">
<div class="org-src-container">
<pre class="src src-shell">nc -p 53 -w 2 -v -v firewall.yournetwork.com 53
nc -u -p 53 -w 2 -v -v firewall.yournetwork.com 53
</pre>
</div>
</div>
</div>

<div id="outline-container-org19e9c12" class="outline-3">
<h3 id="org19e9c12"><span class="section-number-3">10.3</span> Spoof source IP address</h3>
<div class="outline-text-3" id="text-10-3">
<p>
<code>-s</code> option to Netcat: does not work under Cygwin&#x2026;
</p>
</div>
</div>

<div id="outline-container-org8987ccd" class="outline-3">
<h3 id="org8987ccd"><span class="section-number-3">10.4</span> Socat</h3>
<div class="outline-text-3" id="text-10-4">
<p>
Learning socat in terms of netcat: <a href="http://jdimpson.livejournal.com/6534.html">http://jdimpson.livejournal.com/6534.html</a>
</p>

<ul class="org-ul">
<li><p>
<b>Remote access server</b>
</p>

<div class="org-src-container">
<pre class="src src-shell">  socat TCP-LISTEN:2323,reuseaddr EXEC:/bin/bash
</pre>
</div></li>

<li><p>
<b>Data forwarder</b> (aka simple proxy)
</p>

<div class="org-src-container">
<pre class="src src-shell">  socat TCP-L:2323 TCP:localhost:22
</pre>
</div>

<p>
And of course, you can replace either address with any other socat address
we&rsquo;ve already talked about (UDP, UDP-L), or ones we&rsquo;ll talk about in another
post (e.g. SSL).
</p></li>
</ul>
</div>
</div>

<div id="outline-container-orga157ae7" class="outline-3">
<h3 id="orga157ae7"><span class="section-number-3">10.5</span> Packet forger</h3>
<div class="outline-text-3" id="text-10-5">
<p>
SendIP
</p>
</div>
</div>

<div id="outline-container-org729fc99" class="outline-3">
<h3 id="org729fc99"><span class="section-number-3">10.6</span> Lauching attacks via Tor</h3>
<div class="outline-text-3" id="text-10-6">
<p>
<a href="http://www.oreillynet.com/onlamp/blog/2005/07/launching_attacks_via_tor.html">http://www.oreillynet.com/onlamp/blog/2005/07/launching_attacks_via_tor.html</a>
</p>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Fabrice Niessen</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
